# docker-compose
Это инструмент для запуска многоконтейнерных приложений. 

Допустим наше приложение содержит несколько контейнеров: база данных, бэкенд, мл-сервис, фронтенд. Настроить поведение такого приложения через команды в консоли(или bash скрипты) может быть довольно трудно: контейнеры должны запускаться в определённом порядке; перед поднятием следующего контейнера, необходимо дождаться полной загрузки предыдущего; необходимо задавать какое-то поведение при падении определённого контейнера и так далее.

Docker-compose позволяет это сделать удобнее чем ручное прописывание команд в консоли или написание bash-скриптов. Процесс запуска со всеми возможныи тонкостями описываются в специальном файле - `docker-compose.yaml`, по инструкциям которого и запускается приложение.

## Формат YAML
Это язык(формат) для хранения информации в удобочитаемом формате, имеющий простой синтаксис:
- отступы
- ключ-значение
- последовательности(анаглог списков)
- словари

```yaml
# Строительный элемент yaml файла - пара ключ:значение
version:3.8
  # -> {"version": 3.8}


# Можно задавать список:
names:
  - Maksim
  - Anya
  - Emil
  - Ivan
  # -> {"names": ["Maksim", "Anya", "Emil", "Ivan"]}


# Можно делать вложенные словари:
postgres:
    host: postgres_host
    password: postgres_app_password
    port: 5432
    user: postgres_app_user
```

Также в формате yaml есть такой инструмент как якори. Обозначаются якори через знак `&` и определяют некоторый кусок данных, который может повторяться точь-в-точь где-то ещё. Соответственно, вместо того, чтобы во всех местах вставлять один и тот же кусок, удобнее просто вызывать якорь через оператор `<<: *` :
```yaml
junior:
  &junior
  position: junior
  salary: 55000


team:
  backend:
    - Peter:
        <<: *junior
    - Olga:
        <<: *junior
  
```


## Файл docker-compose.yaml
Файл docker-compose строится структурно как yaml файл, но он имеет чётко определённые названия полей(ключей). Рассмотрим некоторые из них. 

Первым делом идет определение версии конфигурации через ключ `version` : 
```yaml 
version: '3.8'
```

Наше приложение состоит из нескольких контейнеров, то есть представляет собой совокупность сервисов. Они описываются ниже, в разделе `services`:
```yaml
services:
  first:
    ... # описание контейнера, как запускать, от кого зависит, указание вольюмов и тд.
  second:
    ... # описание контейнера, как запускать, от кого зависит, указание вольюмов и тд.
  etc:
    ... # описание контейнера, как запускать, от кого зависит, указание вольюмов и тд.
```

Теперь рассмотрим поля(ключи) которые описывают контейнер:
1. `container_name: <name>` - задать имя контейнера.
2. `image: <image>` - указать имя образа, если используется образ из репозитория.
3. `build: <path>` - собрать образ по переданному пути, если нет готового образа в репозитории.
4. `depends_on` - передать список сервисов от которых зависит текущий сервис. Пока все эти сервисы не будут запущены, данный сервис не будет запускаться.
5. `command` - выполнить команду при запуске контейнера, заменяет команду в инструкции CMD или ENTRYPOINT.
6. `volumes` - задать список вольюмов. Вольюм задаётся точно также, как при ручном запуске контейнера.
7. `networks` - задать список сетей, в которые должен быть включён контейнер.
8. `enviroment` - задать список из переменных окружения.
9. `ports` - задать список из пробросов портов.
10. `restart: always` - настройка перезапуска контейнера(в данном случае всегда перезапускается)


Описав все сервисы идём дальше. 

При ручном запуске контейнеров мы предварительно могли также вручную создавать вольюмы и сети. Теперь создание вольюмов и сетей, которые будут использовать наши сервисы выше, можно прописать в docker-compose.

Создание вольюмов:
```yaml
volumes:
  my_database:
    name: my_database
```
По такой инструкции будет создан новый вольюм с именем my_database и его можно использовать как вольюм для сервисов, описанных выше в этом файле, по имени my_database.

Создание сетей:
```yaml
networks:
  app_net:
    name: app_net
```

## Базовая структура docker-compose файла
```yaml
version: ...

services:
  app:
    container_name: <name>
    image/build: ...
    enviroment:
      - VAR=<value>
      - ...
    volumes:
      - volume:<path>
      - ...
    networks:
      - <network_name>
      - ...
    ports:
      - <port>:<port>
    depends_on:
      - other_service
    restart: ...


volumes:
  - volume_name:
      name: volume_name

networks:
  - net_name:
      name: net_name
```

## Команды 
Находясь в папке с файлом docker-compose.yaml можем выполнить:
- `docker-compose ps` - список контейнеров
- `docker-compose up` - поднять приложение
- `docker-compose stop` - остановить поднятые контейнеры
- `docker-compose start` - запустить остановленные контейнеры
- `docker-compose down` - остановить и удалить контейнеры и сеть
